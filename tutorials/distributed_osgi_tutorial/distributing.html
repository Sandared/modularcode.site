<!DOCTYPE html>
<html lang="en"><head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <title>Distributing</title>
    <meta name="description" content="Distributing" />
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen,projection" href="/assets/materialize.css" />
    <link rel="canonical" href="http://localhost:4000/tutorials/distributed_osgi_tutorial/distributing.html" />
    <link rel="alternate" type="application/rss+xml" title="modularcode" href="/feed.xml" />
    
</head>
<!-- Is it a content or a nested page -->
	
	
	
	<style>a {color: #757575;fill:#424242;}a:hover {color: #03a9f4;fill:#03a9f4;}h1,h2,h3,h4,h5,h6{color: #424242;}body{color: #212121; display: flex; min-height: 100vh; flex-direction: column;}nav ul a{color: #424242;}nav .brand-logo{color: #424242}.justify-align{text-align:justify;}nav a{color: #424242;}main{flex: 1 0 auto;}.side-nav li>a{color: #424242;}.side-nav .collapsible-header, .side-nav.fixed .collapsible-header{padding-left:32px;}.side-nav .collapsible-body li a, .side-nav.fixed .collapsible-body li a{padding-left:47px;}h1,h2,h3,h4,h5,h6{-webkit-font-smoothing: antialiased;}.icon-block{padding: 0 15px;}.icon-block .material-icons{font-size: inherit;}.row{margin-bottom:0px;}.logo img{padding-top:3px;}.page-footer{background-color:#03a9f4; padding-top: 0px;}.nav-button{width:20px; height:20px; viewBox:0 0 20 20;}footer h5{color:#FFFFFF;}hr{background-color:#bdbdbd;}.divider{background-color:#bdbdbd;}img{max-width: 100%; height: auto;}.page-footer .footer-copyright{background-color:#03a9f4;}/* Code Highlighting */.highlight .c { color: #bdbdbd; font-style: italic } /* Comment */.highlight .k { color: #212121; font-weight: bold } /* Keyword */.highlight .cm { color: #bdbdbd; font-style: italic } /* Comment.Multiline */.highlight .c1 { color: #bdbdbd; font-style: italic } /* Comment.Single */.highlight .kc { color: #424242; font-weight: bold } /* Keyword.Constant */.highlight .kd { color: #212121; font-weight: bold } /* Keyword.Declaration */.highlight .kn { color: #424242; font-weight: bold } /* Keyword.Namespace */.highlight .kp { color: #424242; font-weight: bold } /* Keyword.Pseudo */.highlight .kr { color: #424242; font-weight: bold } /* Keyword.Reserved */.highlight .kt { color: #424242; font-weight: bold } /* Keyword.Type */.highlight .s { color: #757575 } /* Literal.String */.highlight .n { color: #03a9f4 } /* Name */.highlight .na { color: #03a9f4 } /* Name.Attribute */.highlight .nc { color: #03a9f4} /* Name.Class */.highlight .nd { color: #757575 } /* Name.Decorator */.highlight .nf { color: #03a9f4 } /* Name.Function */.highlight .mf { color: #757575 } /* Literal.Number.Float */.highlight .mh { color: #757575 } /* Literal.Number.Hex */.highlight .mi { color: #757575 } /* Literal.Number.Integer */.highlight .mo { color: #757575 } /* Literal.Number.Oct */.highlight .sb { color: #757575 } /* Literal.String.Backtick */.highlight .sc { color: #757575 } /* Literal.String.Char */.highlight .sd { color: #757575 } /* Literal.String.Doc */.highlight .s2 { color: #757575 } /* Literal.String.Double */.highlight .se { color: #757575 } /* Literal.String.Escape */.highlight .sh { color: #757575 } /* Literal.String.Heredoc */.highlight .si { color:#757575 } /* Literal.String.Interpol */.highlight .sx { color: #757575 } /* Literal.String.Other */.highlight .sr { color: #757575 } /* Literal.String.Regex */.highlight .s1 { color: #757575 } /* Literal.String.Single */.highlight .ss { color: #757575 } /* Literal.String.Symbol */.highlight {tab-size: 4;}div.highlighter-rouge{padding:5px;background:#f5f5f5;border:1px solid #bdbdbd;border-radius:4px;}div.highlight pre.highlight{margin:0px;}code.highlighter-rouge{padding:0px 3px;background:#f5f5f5;border:1px solid #bdbdbd;border-radius:3px;}/* Make headers a little bit smaller */h1{font-size:2.8rem;}h2{font-size:2.5rem;}h3{font-size:2.1rem;}h4{font-size:1.8rem;}h5{font-size:1.3rem;}h6{font-size:1rem;}/* Plain text */p{text-align:justify;}/* Blockquotes */blockquote{border-left:3px solid #03a9f4;font-style:italic;font-weight:300;}/* Tables */table.striped>tbody>tr:nth-child(odd){background-color:#f5f5f5;}/* Cards */.card .card-image .card-title{color: #212121; font-weight: 600; padding-bottom: 0px; padding-left:12px; padding-right: 12px;}.card-content{color: #757575;}.card .card-content{padding-top: 5px;}.card .card-action a:not(.btn):not(.btn-large):not(.btn-large):not(.btn-floating){color: #424242;}.card .card-action a:not(.btn):not(.btn-large):not(.btn-large):not(.btn-floating):hover{color: #03a9f4;}.card.small{height: 225px;}.card-placeholder-image{color:#bdbdbd;}.card-image img{opacity: 0.3;}.card-image h2{opacity: 0.3;}.card .card-image{min-height:60%;}/* Breadcrumbs */nav{background-color: #FFFFFF;}a.breadcrumb{color: #757575;}.breadcrumb:last-child{color:#03a9f4;}.breadcrumb:before{color:#757575;font-size:15px;}nav.breadcrumbs{box-shadow:none;margin-top:4px;}ul.collapsible{list-style-type: none;padding:0px;}.collapsible-header{border-bottom:0px;}.collapsible-body{padding:5px;}/* Table of Contents */.second-level{padding:0px;}.table-of-contents .second-level a{padding-left:40px;font-size:13px;}.table-of-contents a{color:#757575;}.table-of-contents a:hover{border-left:1px solid #03a9f4;color:#03a9f4;}.table-of-contents a.active{border-left:2px solid #03a9f4;color:#757575;}.toc-wrapper li{padding:1px;}/* Navigation Arrows */.prev-nav{top: 50%;left: 3%;position:fixed;}.next-nav{top: 50%;right: 3%;position:fixed;}</style>

  <body>
	<!-- Navigation Header -->
	<nav class="white lighten-1" role="navigation">
	<div class="nav-wrapper container">
		<a id="logo-container" class="brand-logo logo show-on-medium-and-up hide-on-small-only" href="/"><img src="/logo.png"></a>
		<a id="logo-container" class="brand-logo logo show-on-small hide-on-med-and-up" href="/"><img src="/logo-small.png"></a>
	  
	  
	
	  <ul class="right hide-on-med-and-down">
		
			
			<li><a href="/tutorials.html">Tutorials</a></li>
		
			
			<li><a href="/modules.html">Modules</a></li>
		
			
			<li><a href="/projects.html">Projects</a></li>
		
			
			<li><a href="/contribute.html">Contribute</a></li>
		
		
			<li>
				<a title="modularcode.site on GitHub" href="https://github.com/Sandared/modularcode.site"> 
					<svg class="nav-button" xmlns="http://www.w3.org/2000/svg">
						<title>github</title>
						<path d="M10 0C4.477 0 0 4.477 0 10c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.268 2.75 1.026A9.578 9.578 0 0 1 10 4.836c.85.004 1.705.114 2.504.337 1.909-1.294 2.747-1.026 2.747-1.026.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.579.688.481C17.137 18.163 20 14.418 20 10c0-5.523-4.478-10-10-10" fill-rule="evenodd">
						</path>
					</svg>					
				</a>
			</li>
		
		
		
			<li>
				<a title="SanfteSchorle on Twitter" href="https://twitter.com/SanfteSchorle"> 
					<svg class="nav-button" xmlns="http://www.w3.org/2000/svg">
						<title>twitter</title>
						<path d="M15.115 7.788c.005.11.009.223.009.335 0 3.43-2.611 7.384-7.386 7.384-1.467 0-2.831-.43-3.98-1.166a5.244 5.244 0 0 0 3.843-1.075 2.596 2.596 0 0 1-2.424-1.801 2.645 2.645 0 0 0 1.171-.045 2.597 2.597 0 0 1-2.082-2.544v-.033c.351.194.752.311 1.177.324a2.59 2.59 0 0 1-1.154-2.16c0-.475.127-.92.35-1.305A7.37 7.37 0 0 0 9.99 8.414a2.596 2.596 0 0 1 4.423-2.367 5.174 5.174 0 0 0 1.648-.63 2.602 2.602 0 0 1-1.142 1.436 5.17 5.17 0 0 0 1.491-.41 5.233 5.233 0 0 1-1.295 1.345M10 0C4.486 0 0 4.486 0 10s4.486 10 10 10 10-4.486 10-10S15.514 0 10 0" fill-rule="evenodd">
						</path>
					</svg>			
				</a>
			</li>
		
	  </ul>

	  <ul id="nav-mobile" class="side-nav">
		<li><a href="http://localhost:4000">Home</a></li>
		<li class="divider"></li>
		
			
			<li><a href="/tutorials.html">Tutorials</a></li>
			<li class="divider"></li>
		
			
			<li><a href="/modules.html">Modules</a></li>
			<li class="divider"></li>
		
			
			<li><a href="/projects.html">Projects</a></li>
			<li class="divider"></li>
		
			
			<li><a href="/contribute.html">Contribute</a></li>
			<li class="divider"></li>
		
		
			<li>
				<a title="modularcode.site on GitHub" href="https://github.com/Sandared/modularcode.site"> 
					<svg class="nav-button" xmlns="http://www.w3.org/2000/svg">
						<title>github</title>
						<path d="M10 0C4.477 0 0 4.477 0 10c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.268 2.75 1.026A9.578 9.578 0 0 1 10 4.836c.85.004 1.705.114 2.504.337 1.909-1.294 2.747-1.026 2.747-1.026.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.579.688.481C17.137 18.163 20 14.418 20 10c0-5.523-4.478-10-10-10" fill-rule="evenodd">
						</path>
					</svg>					
				</a>
			</li>
			<li class="divider"></li>
		
		
		
			<li>
				<a title="SanfteSchorle on Twitter" href="https://twitter.com/SanfteSchorle"> 
					<svg class="nav-button" xmlns="http://www.w3.org/2000/svg">
						<title>twitter</title>
						<path d="M15.115 7.788c.005.11.009.223.009.335 0 3.43-2.611 7.384-7.386 7.384-1.467 0-2.831-.43-3.98-1.166a5.244 5.244 0 0 0 3.843-1.075 2.596 2.596 0 0 1-2.424-1.801 2.645 2.645 0 0 0 1.171-.045 2.597 2.597 0 0 1-2.082-2.544v-.033c.351.194.752.311 1.177.324a2.59 2.59 0 0 1-1.154-2.16c0-.475.127-.92.35-1.305A7.37 7.37 0 0 0 9.99 8.414a2.596 2.596 0 0 1 4.423-2.367 5.174 5.174 0 0 0 1.648-.63 2.602 2.602 0 0 1-1.142 1.436 5.17 5.17 0 0 0 1.491-.41 5.233 5.233 0 0 1-1.295 1.345M10 0C4.486 0 0 4.486 0 10s4.486 10 10 10 10-4.486 10-10S15.514 0 10 0" fill-rule="evenodd">
						</path>
					</svg>			
				</a>
			</li>
			<li class="divider"></li>
		
	  </ul>        

	  <a data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
	</div>
</nav>
	
	
	
  <main>	
  <div class="container">
		<div class="row">	
		
			<div id="text-content" class="section col s12 l10">
				


<nav class="breadcrumbs">
	<div class="nav-wrapper">
	
	
		
	
		
			
			
			
			
			
							
				
				
							
				
				
							
				
				
			
				
					
					<a href="http://localhost:4000/tutorials.html" class="breadcrumb">Tutorials</a>
				
			
		
	
		
			
			
			
			
			
							
				
				
							
				
				
							
				
				
					
				
				<a href="http://localhost:4000/tutorials/distributed_osgi_tutorial.html" class="breadcrumb">Distributed OSGi with Zookeeper</a>
				
			
		
	
		
			
			
			
			
			
							
				
				
							
				
				
							
				
				
					
				
				<a href="http://localhost:4000/tutorials/distributed_osgi_tutorial/distributing.html" class="breadcrumb">Distributing</a>
				
			
		
	
	</div>
</nav>

				<h1 id="distributing">Distributing</h1>

<p><img src="img/overview-distributing.png" alt="Chat Service" /></p>

<h2 id="application">Application</h2>

<p>We now need to create an environment in which our Chat provider can run. Obviously, since we want to demonstrate distributed OSGi, we should then provide an environment with distribution, using the Zookeeper server we started in the previous section.</p>

<p>We provide this environment in an application project. We therefore neeed to create a new Bndtools project called <code class="highlighter-rouge">osgi.enroute.examples.chat.application</code>. Please use your own name, but the suffix must be <code class="highlighter-rouge">.application</code>.</p>

<p>Go ahead and create it.</p>

<p>This creates a simple Angular based application using a REST backend. We’ll ignore the GUI for now, this is saved for last.</p>

<p>In the runtime we need the following roles:</p>

<ul>
  <li>A Distribution provider</li>
  <li>A Topology Manager</li>
  <li>A Discovery model</li>
</ul>

<p>The OSGi enRoute distro does not contain the Zookeeper discovery bundle. Unfortunately, this bundle is not on Maven Central. You can find it here http://repository.amdatu.org/release/org.amdatu.remote.discovery.zookeeper/. You can drag the URL to the latest version on the <code class="highlighter-rouge">Local</code> repository in the Bndtools Repository view. This will store the bundle in your cnf/local folder and make it available to bnd.</p>

<p>Then click on the <code class="highlighter-rouge">osgi.enroute.examples.chat.bndrun</code> file and select the <code class="highlighter-rouge">Run</code> tab.</p>

<p>The application bundle should already be there, if not add it.</p>

<p>From the list of <code class="highlighter-rouge">Available Bundles</code> add the <code class="highlighter-rouge">org.amdatu.remote.discovery.zookeeper</code> bundle. You could also add the <code class="highlighter-rouge">org.amdatu.remote.admin.http</code> and <code class="highlighter-rouge">org.amdatu.remote.topology.promiscuous</code> bundles but if you do not have other distribution providers in your distro then the Zookeeper bundle should suffice.</p>

<p>Also add our Chat client (<code class="highlighter-rouge">osgi.enroute.examples.chat.provider</code>) to the list if <code class="highlighter-rouge">Run Requirements</code>. We do not want to leave this crucial bundle out!</p>

<p>Resolve, save.</p>

<h2 id="configuring">Configuring</h2>

<p>We need to configure the Amdatu Distribution provider. We could do this by hand like we did for the <code class="highlighter-rouge">user.name</code> of the Chat service but the configuration for the Zookeeper discoverer is rather extensive and uses really long names. So we use the standard configuration facility of an OSGi enRoute applications.</p>

<p>In OSGi enRoute we have the <em>Configurer Extender</em>. This is a bundle that watches a special file in other bundles, the <code class="highlighter-rouge">configuration/configuration.json</code> file. If this file is present, it wil parse it and turn the records in there in OSGi Configuration Admin configurations.</p>

<p>If you look in the <code class="highlighter-rouge">ChatApplication</code> class then you’ll see that we require the Configurer Extender there with the <code class="highlighter-rouge">@RequireConfigurerExtender</code> annotation.</p>

<p>So all we need to do is to add our configuration to this <code class="highlighter-rouge">configuration/configuration.json</code> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[
  {
    "service.pid":"org.amdatu.remote.discovery.zookeeper",
    "org.amdatu.remote.discovery.zookeeper.connectstring"
       : "localhost:6789",
    "org.amdatu.remote.discovery.zookeeper.host"
       :"localhost",
    "org.amdatu.remote.discovery.zookeeper.rootpath"
       :"/rsa",
    "org.amdatu.remote.discovery.zookeeper.path"
       : "org.amdatu.remote.discovery.zookeeper",
    "org.amdatu.remote.discovery.zookeeper.schedule"
       : 10
  }
] 
</code></pre></div></div>

<h2 id="debugging">Debugging</h2>

<p>We could start the <code class="highlighter-rouge">osgi.enroute.examples.chat.bndrun</code> file but then we do not get Gogo nor Xray. So let’s instead use the <code class="highlighter-rouge">debug.bndrun</code>. This bndrun file inherits the settings of the <code class="highlighter-rouge">osgi.enroute.examples.chat.bndrun</code> file but adds a set of bundles like XRay and Gogo to make the life of a debugger less horrible.</p>

<p>So double click <code class="highlighter-rouge">osgi.enroute.examples.chat.bndrun</code> and select the <code class="highlighter-rouge">Run</code> tab. Resolve, save, and click on the <code class="highlighter-rouge">Debug</code> button.</p>

<h2 id="zookeeper">Zookeeper</h2>

<p>You now should have two frameworks running:</p>

<ul>
  <li><code class="highlighter-rouge">debug.bndrun</code> – The application on <a href="http://localhost:8080">http://localhost:8080</a></li>
  <li><code class="highlighter-rouge">zk.bndrun</code> – A Zookeeper server running on port <code class="highlighter-rouge">localhost:6789</code></li>
</ul>

<p>This might require some shuffling of consoles.</p>

<p>You could check the logs to see if there were no issues: <a href="http://localhost:8080/system/console/logs">http://localhost:8080/system/console/logs</a></p>

<p>You might want to check the Gogo shell commands:</p>

<div class="shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g! members
osgi
</code></pre></div></div>

<p>On the Zookeeper console we could check if there is a node created. We configured the Zookeeper Configurer to use a root node <code class="highlighter-rouge">/rsa</code>.</p>

<div class="shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g! zk:ls /
zookeeper
rsa
g! zk:ls /rsa
80082c04-927d-0015-12ef-f924e90c7d18
g! data /rsa/80082c04-927d-0015-12ef-f924e90c7d18
http://localhost:8080/org.amdatu.remote.discovery.zookeeper/
</code></pre></div></div>

<p>Obviously <em>your</em> unreadable numbers will look different.</p>

<h2 id="exporting">Exporting</h2>

<p>We’ll update our Chat service to be exported. We can do this because the Chat service is properly designed for distribution. The only data types we’re using are String and Message. Message is a DTO and they are explicitly designed to be serialized.</p>

<p>So the only thing we have to do is add the magic property to our <code class="highlighter-rouge">ChatImpl</code> class.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Designate</span><span class="o">(</span><span class="n">ocd</span><span class="o">=</span><span class="n">Configuration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">factory</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
<span class="nd">@Component</span><span class="o">(</span>
	<span class="n">name</span> <span class="o">=</span> <span class="s">"osgi.enroute.examples.chat"</span><span class="o">,</span> 
	<span class="n">property</span> <span class="o">=</span> <span class="o">{</span>
		<span class="s">"user.name=osgi"</span><span class="o">,</span>
		<span class="s">"service.exported.interfaces=*"</span>
	<span class="o">}</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatImpl</span> <span class="kd">implements</span> <span class="n">Chat</span> <span class="o">{</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">send</span><span class="o">(</span><span class="n">Message</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s: %s%n"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">from</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>The results are rather underwhelming, nothing happens.</p>

<h2 id="cluster">Cluster</h2>
<p>We now need to get the cluster up and running. You should make sure that you have no frameworks running and then select one of the following options.</p>

<h3 id="with-a-presenter">With a Presenter</h3>

<p>It this tutorial is given by a presenter then he will provide you with an IP number to his machine. If the presenter’s IP number is  172.16.8.8 and your IP number is 172.16.8.42 then your <code class="highlighter-rouge">configuration/configuration.json</code> should look like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[
  {
    "service.pid":"org.amdatu.remote.discovery.zookeeper",
    "org.amdatu.remote.discovery.zookeeper.connectstring": 
                "172.16.8.8:6789",
    "org.amdatu.remote.discovery.zookeeper.host":
                "172.16.8.42",
    "org.amdatu.remote.discovery.zookeeper.rootpath":"/rsa",
    "org.amdatu.remote.discovery.zookeeper.path":
                 "org.amdatu.remote.discovery.zookeeper",
    "org.amdatu.remote.discovery.zookeeper.schedule":10
  }
] 
</code></pre></div></div>

<p>You can then just start <code class="highlighter-rouge">debug.bndrun</code>. The application will contact the presenter’s Zookeeper and will from there find its peers.</p>

<h3 id="if-you-have-friends">If You Have Friends</h3>

<p>If you have some nearby friends then it is now easy even more easy to share than on Facebook.</p>

<p>Assuming you’re the primary and you’re on IP address 172.16.8.8. This will be the Zookeeper connect address to use for everybody (<code class="highlighter-rouge">"org.amdatu.remote.discovery.zookeeper.connectstring</code>). The <code class="highlighter-rouge">"org.amdatu.remote.discovery.zookeeper.host"</code>, however, must be set to your machine’s IP number. Your configuration therefore looks like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[
  {
    "service.pid":"org.amdatu.remote.discovery.zookeeper",
    "org.amdatu.remote.discovery.zookeeper.connectstring": 
                "172.16.8.8:6789",
    "org.amdatu.remote.discovery.zookeeper.host":
                "172.16.8.8",
    "org.amdatu.remote.discovery.zookeeper.rootpath":"/rsa",
    "org.amdatu.remote.discovery.zookeeper.path":
                 "org.amdatu.remote.discovery.zookeeper",
    "org.amdatu.remote.discovery.zookeeper.schedule":10
  }
] 
</code></pre></div></div>

<p>The primary must also ensure that it has a running Zookeeper. That is, it should run the <code class="highlighter-rouge">zk.bndrun</code> file we prepared earlier.</p>

<p>So one of your friends that has IP address 172.16.8.42 then he should configure like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[
  {
    "service.pid":"org.amdatu.remote.discovery.zookeeper",
    "org.amdatu.remote.discovery.zookeeper.connectstring": 
                "172.16.8.8:6789",
    "org.amdatu.remote.discovery.zookeeper.host":
                "172.16.8.42",
    "org.amdatu.remote.discovery.zookeeper.rootpath":"/rsa",
    "org.amdatu.remote.discovery.zookeeper.path":
                 "org.amdatu.remote.discovery.zookeeper",
    "org.amdatu.remote.discovery.zookeeper.schedule":10
  }
] 
</code></pre></div></div>

<p>Each of you can then just start <code class="highlighter-rouge">debug.bndrun</code>. The primary will contact its local Zookeeper; the secondaries will contact the primary Zookeeper and will from there find its peers.</p>

<h3 id="if-you-dont-have-friends">If You Don’t Have Friends</h3>

<p>You should first make sure that you got one Zookeeper running. If there are no Zookeepers, run the <code class="highlighter-rouge">zk.bndrun</code> file.</p>

<p>You should also ensure that you got the <code class="highlighter-rouge">debug.bndrun</code> console, otherwise Run this file.</p>

<p>To see distributed OSGi work without friends we need to have at least two different frameworks and a Zookeeper. We can start a second framework but we cannot use the same <code class="highlighter-rouge">debug.bndrun</code> file because this would use the same storage area and same HTTP port. So we need to clone this <code class="highlighter-rouge">debug.bndrun</code> file.</p>

<p>Therefore, make a copy of this file and call it <code class="highlighter-rouge">debug-alt.bndrun</code>.</p>

<p>In this file we need to set a different storage area and ensure that we have a different HTTP port:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-include:               ~osgi.enroute.examples.chat.bndrun
-runrequires.debug:     ${debug-bundles}
-runstorage:            generated/fw-alt
-runtrace:              true
-runproperties:         org.osgi.service.http.port=8081
</code></pre></div></div>

<p><strong>Note:</strong> Earlier workspaces set the <code class="highlighter-rouge">org.osgi.service.http.port</code> property in such a way that it could not be overridden. You might want to check the <code class="highlighter-rouge">cnf/ext/enroute-distro.bnd</code> file. It should not contain the the property. If it does, remove it.</p>

<p>We don’t have to change the configuration, the default configuration works fine for both running frameworks. Just through the Web Console change the name of the local user so it will not be the same for the second framework we start.</p>

<p>You now need to Resolve the <code class="highlighter-rouge">debug-alt.bndrun</code> file and save it. Then click on the <code class="highlighter-rouge">Debug</code> button to start it.</p>

<p>Ok, you should now have three Frameworks running simultaneously in three different consoles!</p>

<ul>
  <li><code class="highlighter-rouge">debug.bndrun</code> – The application on <a href="http://localhost:8080">http://localhost:8080</a></li>
  <li><code class="highlighter-rouge">debug-alt.bndrun</code> – The application on <a href="http://localhost:8081">http://localhost:8081</a></li>
  <li><code class="highlighter-rouge">zk.bndrun</code> – A Zookeeper server running on port <code class="highlighter-rouge">localhost:6789</code></li>
</ul>

<p>We need to change the name of the user for each framework since we use a Map to store the Chat services. If we use the same name on both frameworks they will not be able to discriminate between them. So go to <a href="http://localhost:8081/system/console/configMgr">http://localhost:8081/system/console/configMgr</a> and select the Chat provider configuration. Set the <code class="highlighter-rouge">user.name</code> to something like <code class="highlighter-rouge">alternate</code>.</p>

<p>The two different runs can share the same <code class="highlighter-rouge">configuration/configuration.json</code> because we do not specify the port in there, the Amdatu Zookeeper discovery code will automatically detect on which port the HTTP server is running and use that one. You can verify that by going to the <code class="highlighter-rouge">zk.bndrun</code> console and checking the content of the <code class="highlighter-rouge">/rsa/*</code> nodes. It should now have 2 entries in the <code class="highlighter-rouge">/rsa</code> node. One for each framework.</p>

<div class="shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g! zk:ls /rsa
508a414b-2e7e-0015-1276-b3915cbaf5a9
8050ba54-2e7e-0015-11c3-f08c767af334
g! data /rsa/508a414b-2e7e-0015-1276-b3915cbaf5a9
http://0.0.0.0:8080/org.amdatu.remote.discovery.zookeeper/
g! data /rsa/8050ba54-2e7e-0015-11c3-f08c767af334
http://localhost:8081/org.amdatu.remote.discovery.zookeeper/
</code></pre></div></div>

<p>Again, your number may vary (we hope).</p>

<h2 id="running">Running</h2>

<p>You should now be able to see the members:</p>

<div class="shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g! members
osgi
alternate
</code></pre></div></div>

<p>You can now talk to them through the OSGi Chat command! In the primary console (<code class="highlighter-rouge">debug.bndrun</code>)  our name is the default <code class="highlighter-rouge">osgi</code> name since we did not set the configuration. So from this console:</p>

<div class="shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g! send osgi alternate "You should change your name!"
true
osgi: What name?
g! send osgi alternate "Ah forget it!"
</code></pre></div></div>

<p>Don’t wait too long for <code class="highlighter-rouge">alternate</code> to reply, you’ll have to do that yourself in the <code class="highlighter-rouge">debug-alt.bndrun</code> console.</p>

<h2 id="notes">Notes</h2>

<p>This Zookeeper server runs in standalone mode. This is fine for testing but to make this work in an actual cluster it should be replicated.</p>


		    </div>
			<div class="col hide-on-med-and-down l2">
				<div id="toc-wrapper" class="toc-wrapper pin-top">
				  <ul id="toc" class="section table-of-contents">
					
				  </ul>
				</div>
			</div>
			
			
				
				<div class="col s6 left-align hide-on-large-only show-on-med-and-down"><a href="zookeeper.html"><i class="large material-icons">keyboard_arrow_left</i></a></div>
			
			
				<div class="col s6  right-align hide-on-large-only show-on-med-and-down"><a href="gui.html"><i class="large material-icons">keyboard_arrow_right</i></a></div>
			
			
			
				<div class="prev-nav hide-on-med-and-down"><a href="zookeeper.html"><i class="small material-icons">keyboard_arrow_left</i></a></div>
			
			
				<div class="next-nav hide-on-med-and-down"><a href="gui.html"><i class="small material-icons">keyboard_arrow_right</i></a></div>
			
		
			
    </div> 
	
  </div>
  </main>
	<footer class="page-footer">
    <!--<div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5>Lorem Ipsum</h5>
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        </div>
      </div>
    </div>-->
    <div class="footer-copyright">
        <div class="container">
            <div>
				<span style="text-align: left; float: left; width: 30%;">
				Made with <a target="_blank" href="http://materializecss.com">Materialize</a>
				</span>
				<span style="text-align: center; float: left; width: 40%;">
				Copyright © 2018 <a href="https://twitter.com/SanfteSchorle">Thomas Driessen</a>
				</span>
                <span style="text-align: right; float: left; width: 30%;">
				Powered by <a target="_blank" href="http://jekyllrb.com/">Jekyll</a>
                </span>
            </div>
        </div>
    </div>
</footer>      
	<!--  Scripts-->  

<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/materialize.min.js"></script>
<script src="/assets/js/init.js"></script>	
	<script src="/assets/js/content.js"></script>	
  </body>

</html>