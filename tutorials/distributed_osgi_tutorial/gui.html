<!DOCTYPE html>
<html lang="en"><head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <title>A Chat Web App</title>
    <meta name="description" content="A Chat Web App" />
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen,projection" href="/assets/materialize.css" />
    <link rel="canonical" href="http://localhost:4000/tutorials/distributed_osgi_tutorial/gui.html" />
    <link rel="alternate" type="application/rss+xml" title="modularcode" href="/feed.xml" />
    
</head>
<!-- Is it a content or a nested page -->
	
	
	
	<style>a {color: #757575;fill:#424242;}a:hover {color: #03a9f4;fill:#03a9f4;}h1,h2,h3,h4,h5,h6{color: #424242;}body{color: #212121; display: flex; min-height: 100vh; flex-direction: column;}nav ul a{color: #424242;}nav .brand-logo{color: #424242}.justify-align{text-align:justify;}nav a{color: #424242;}main{flex: 1 0 auto;}.side-nav li>a{color: #424242;}.side-nav .collapsible-header, .side-nav.fixed .collapsible-header{padding-left:32px;}.side-nav .collapsible-body li a, .side-nav.fixed .collapsible-body li a{padding-left:47px;}h1,h2,h3,h4,h5,h6{-webkit-font-smoothing: antialiased;}.icon-block{padding: 0 15px;}.icon-block .material-icons{font-size: inherit;}.row{margin-bottom:0px;}.logo img{padding-top:3px;}.page-footer{background-color:#03a9f4; padding-top: 0px;}.nav-button{width:20px; height:20px; viewBox:0 0 20 20;}footer h5{color:#FFFFFF;}hr{background-color:#bdbdbd;}.divider{background-color:#bdbdbd;}img{max-width: 100%; height: auto;}.page-footer .footer-copyright{background-color:#03a9f4;}/* Code Highlighting */.highlight .c { color: #bdbdbd; font-style: italic } /* Comment */.highlight .k { color: #212121; font-weight: bold } /* Keyword */.highlight .cm { color: #bdbdbd; font-style: italic } /* Comment.Multiline */.highlight .c1 { color: #bdbdbd; font-style: italic } /* Comment.Single */.highlight .kc { color: #424242; font-weight: bold } /* Keyword.Constant */.highlight .kd { color: #212121; font-weight: bold } /* Keyword.Declaration */.highlight .kn { color: #424242; font-weight: bold } /* Keyword.Namespace */.highlight .kp { color: #424242; font-weight: bold } /* Keyword.Pseudo */.highlight .kr { color: #424242; font-weight: bold } /* Keyword.Reserved */.highlight .kt { color: #424242; font-weight: bold } /* Keyword.Type */.highlight .s { color: #757575 } /* Literal.String */.highlight .n { color: #03a9f4 } /* Name */.highlight .na { color: #03a9f4 } /* Name.Attribute */.highlight .nc { color: #03a9f4} /* Name.Class */.highlight .nd { color: #757575 } /* Name.Decorator */.highlight .nf { color: #03a9f4 } /* Name.Function */.highlight .mf { color: #757575 } /* Literal.Number.Float */.highlight .mh { color: #757575 } /* Literal.Number.Hex */.highlight .mi { color: #757575 } /* Literal.Number.Integer */.highlight .mo { color: #757575 } /* Literal.Number.Oct */.highlight .sb { color: #757575 } /* Literal.String.Backtick */.highlight .sc { color: #757575 } /* Literal.String.Char */.highlight .sd { color: #757575 } /* Literal.String.Doc */.highlight .s2 { color: #757575 } /* Literal.String.Double */.highlight .se { color: #757575 } /* Literal.String.Escape */.highlight .sh { color: #757575 } /* Literal.String.Heredoc */.highlight .si { color:#757575 } /* Literal.String.Interpol */.highlight .sx { color: #757575 } /* Literal.String.Other */.highlight .sr { color: #757575 } /* Literal.String.Regex */.highlight .s1 { color: #757575 } /* Literal.String.Single */.highlight .ss { color: #757575 } /* Literal.String.Symbol */.highlight {tab-size: 4;}div.highlighter-rouge{padding:5px;background:#f5f5f5;border:1px solid #bdbdbd;border-radius:4px;}div.highlight pre.highlight{margin:0px;}code.highlighter-rouge{padding:0px 3px;background:#f5f5f5;border:1px solid #bdbdbd;border-radius:3px;}/* Make headers a little bit smaller */h1{font-size:2.8rem;}h2{font-size:2.5rem;}h3{font-size:2.1rem;}h4{font-size:1.8rem;}h5{font-size:1.3rem;}h6{font-size:1rem;}/* Plain text */p{text-align:justify;}/* Blockquotes */blockquote{border-left:3px solid #03a9f4;font-style:italic;font-weight:300;}/* Tables */table.striped>tbody>tr:nth-child(odd){background-color:#f5f5f5;}/* Cards */.card .card-image .card-title{color: #212121; font-weight: 600; padding-bottom: 0px; padding-left:12px; padding-right: 12px;}.card-content{color: #757575;}.card .card-content{padding-top: 5px;}.card .card-action a:not(.btn):not(.btn-large):not(.btn-large):not(.btn-floating){color: #424242;}.card .card-action a:not(.btn):not(.btn-large):not(.btn-large):not(.btn-floating):hover{color: #03a9f4;}.card.small{height: 225px;}.card-placeholder-image{color:#bdbdbd;}.card-image img{opacity: 0.3;}.card-image h2{opacity: 0.3;}.card .card-image{min-height:60%;}/* Breadcrumbs */nav{background-color: #FFFFFF;}a.breadcrumb{color: #757575;}.breadcrumb:last-child{color:#03a9f4;}.breadcrumb:before{color:#757575;font-size:15px;}nav.breadcrumbs{box-shadow:none;margin-top:4px;}ul.collapsible{list-style-type: none;padding:0px;}.collapsible-header{border-bottom:0px;}.collapsible-body{padding:5px;}/* Table of Contents */.second-level{padding:0px;}.table-of-contents .second-level a{padding-left:40px;font-size:13px;}.table-of-contents a{color:#757575;}.table-of-contents a:hover{border-left:1px solid #03a9f4;color:#03a9f4;}.table-of-contents a.active{border-left:2px solid #03a9f4;color:#757575;}.toc-wrapper li{padding:1px;}/* Navigation Arrows */.prev-nav{top: 50%;left: 3%;position:fixed;}.next-nav{top: 50%;right: 3%;position:fixed;}</style>

  <body>
	<!-- Navigation Header -->
	<nav class="white lighten-1" role="navigation">
	<div class="nav-wrapper container">
		<a id="logo-container" class="brand-logo logo show-on-medium-and-up hide-on-small-only" href="/"><img src="/logo.png"></a>
		<a id="logo-container" class="brand-logo logo show-on-small hide-on-med-and-up" href="/"><img src="/logo-small.png"></a>
	  
	  
	
	  <ul class="right hide-on-med-and-down">
		
			
			<li><a href="/tutorials.html">Tutorials</a></li>
		
			
			<li><a href="/modules.html">Modules</a></li>
		
			
			<li><a href="/projects.html">Projects</a></li>
		
			
			<li><a href="/contribute.html">Contribute</a></li>
		
		
			<li>
				<a title="modularcode.site on GitHub" href="https://github.com/Sandared/modularcode.site"> 
					<svg class="nav-button" xmlns="http://www.w3.org/2000/svg">
						<title>github</title>
						<path d="M10 0C4.477 0 0 4.477 0 10c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.268 2.75 1.026A9.578 9.578 0 0 1 10 4.836c.85.004 1.705.114 2.504.337 1.909-1.294 2.747-1.026 2.747-1.026.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.579.688.481C17.137 18.163 20 14.418 20 10c0-5.523-4.478-10-10-10" fill-rule="evenodd">
						</path>
					</svg>					
				</a>
			</li>
		
		
		
			<li>
				<a title="SanfteSchorle on Twitter" href="https://twitter.com/SanfteSchorle"> 
					<svg class="nav-button" xmlns="http://www.w3.org/2000/svg">
						<title>twitter</title>
						<path d="M15.115 7.788c.005.11.009.223.009.335 0 3.43-2.611 7.384-7.386 7.384-1.467 0-2.831-.43-3.98-1.166a5.244 5.244 0 0 0 3.843-1.075 2.596 2.596 0 0 1-2.424-1.801 2.645 2.645 0 0 0 1.171-.045 2.597 2.597 0 0 1-2.082-2.544v-.033c.351.194.752.311 1.177.324a2.59 2.59 0 0 1-1.154-2.16c0-.475.127-.92.35-1.305A7.37 7.37 0 0 0 9.99 8.414a2.596 2.596 0 0 1 4.423-2.367 5.174 5.174 0 0 0 1.648-.63 2.602 2.602 0 0 1-1.142 1.436 5.17 5.17 0 0 0 1.491-.41 5.233 5.233 0 0 1-1.295 1.345M10 0C4.486 0 0 4.486 0 10s4.486 10 10 10 10-4.486 10-10S15.514 0 10 0" fill-rule="evenodd">
						</path>
					</svg>			
				</a>
			</li>
		
	  </ul>

	  <ul id="nav-mobile" class="side-nav">
		<li><a href="http://localhost:4000">Home</a></li>
		<li class="divider"></li>
		
			
			<li><a href="/tutorials.html">Tutorials</a></li>
			<li class="divider"></li>
		
			
			<li><a href="/modules.html">Modules</a></li>
			<li class="divider"></li>
		
			
			<li><a href="/projects.html">Projects</a></li>
			<li class="divider"></li>
		
			
			<li><a href="/contribute.html">Contribute</a></li>
			<li class="divider"></li>
		
		
			<li>
				<a title="modularcode.site on GitHub" href="https://github.com/Sandared/modularcode.site"> 
					<svg class="nav-button" xmlns="http://www.w3.org/2000/svg">
						<title>github</title>
						<path d="M10 0C4.477 0 0 4.477 0 10c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.268 2.75 1.026A9.578 9.578 0 0 1 10 4.836c.85.004 1.705.114 2.504.337 1.909-1.294 2.747-1.026 2.747-1.026.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.579.688.481C17.137 18.163 20 14.418 20 10c0-5.523-4.478-10-10-10" fill-rule="evenodd">
						</path>
					</svg>					
				</a>
			</li>
			<li class="divider"></li>
		
		
		
			<li>
				<a title="SanfteSchorle on Twitter" href="https://twitter.com/SanfteSchorle"> 
					<svg class="nav-button" xmlns="http://www.w3.org/2000/svg">
						<title>twitter</title>
						<path d="M15.115 7.788c.005.11.009.223.009.335 0 3.43-2.611 7.384-7.386 7.384-1.467 0-2.831-.43-3.98-1.166a5.244 5.244 0 0 0 3.843-1.075 2.596 2.596 0 0 1-2.424-1.801 2.645 2.645 0 0 0 1.171-.045 2.597 2.597 0 0 1-2.082-2.544v-.033c.351.194.752.311 1.177.324a2.59 2.59 0 0 1-1.154-2.16c0-.475.127-.92.35-1.305A7.37 7.37 0 0 0 9.99 8.414a2.596 2.596 0 0 1 4.423-2.367 5.174 5.174 0 0 0 1.648-.63 2.602 2.602 0 0 1-1.142 1.436 5.17 5.17 0 0 0 1.491-.41 5.233 5.233 0 0 1-1.295 1.345M10 0C4.486 0 0 4.486 0 10s4.486 10 10 10 10-4.486 10-10S15.514 0 10 0" fill-rule="evenodd">
						</path>
					</svg>			
				</a>
			</li>
			<li class="divider"></li>
		
	  </ul>        

	  <a data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
	</div>
</nav>
	
	
	
  <main>	
  <div class="container">
		<div class="row">	
		
			<div id="text-content" class="section col s12 l10">
				


<nav class="breadcrumbs">
	<div class="nav-wrapper">
	
	
		
	
		
			
			
			
			
			
							
				
				
							
				
				
							
				
				
			
				
					
					<a href="http://localhost:4000/tutorials.html" class="breadcrumb">Tutorials</a>
				
			
		
	
		
			
			
			
			
			
							
				
				
							
				
				
							
				
				
					
				
				<a href="http://localhost:4000/tutorials/distributed_osgi_tutorial.html" class="breadcrumb">Distributed OSGi with Zookeeper</a>
				
			
		
	
		
			
			
			
			
			
							
				
				
							
				
				
							
				
				
					
				
				<a href="http://localhost:4000/tutorials/distributed_osgi_tutorial/gui.html" class="breadcrumb">A Chat Web App</a>
				
			
		
	
	</div>
</nav>

				<h1 id="a-chat-web-app">A Chat Web App</h1>

<p><img src="img/overview.png" alt="Chat Service" /></p>

<p>We now have a chat client with a Gogo shell command. This works for testing but is not competition to Skype. So can we add a GUI to this model? With OSGi enRoute: Yes, we can! When we created the <code class="highlighter-rouge">osgi.enroute.examples.chat.application</code> we already created an unrelated GUI on <a href="http://localhost:8080">http://localhost:8080</a>. Let’s see how we can make this into a chat client.</p>

<h2 id="gui">GUI</h2>

<p>Fortunately, we decided to keep the problem simple. Each framework represents a single user. We’ll keep the same simplification for the GUI. We’re not logging in, we’re assuming that the framework is one user.</p>

<p>This makes the GUI simple. We need the following parts in our GUI:</p>

<ul>
  <li>A list of users</li>
  <li>Chat history</li>
  <li>Input message</li>
  <li>Send button</li>
</ul>

<p><img src="img/gui-layout.png" alt="GUI Layout" /></p>

<h2 id="scope">Scope</h2>

<p>This tutorial is not about learning Angular, HTML, CSS, Javascript and the other languages popular on the web. The goal is to quickly create a simple GUI on our Chat service model. We will provide some high level information but then provide the different files that need to be modified in your application project. We won’t go into detail how they work.</p>

<h2 id="angular">Angular</h2>

<p>As said, it is not the intention of this tutorial to explain <a href="https://angularjs.org/">Angular</a> in detail. The template used to setup the OSGi enRoute applications provides a minimal example. This example is structured as follows:</p>

<ul>
  <li>A REST server for <code class="highlighter-rouge">GET /rest/upper/&lt;word&gt;</code></li>
  <li>The <code class="highlighter-rouge">static/&lt;app name&gt;/index.html</code> contains the ‘outer’ page of the application with the menu, alerts, header and footer. One element in this page is filled in by the app, this is the element with the <code class="highlighter-rouge">ng-view</code> attribute.</li>
  <li>A <code class="highlighter-rouge">web/main.js</code> file. This file contains the Javascript code. It is an Angular module and defines the dependencies. In the template it sets up a routing table. Routes are matched against the part after the <code class="highlighter-rouge">#/</code> in the application’s URL. The template has a Home page and an About page. A page gets a <em>controller</em> during configuration. A controller is a Javascript function that gets called when the route is activated. A parameter in the invocation is the <code class="highlighter-rouge">$scope</code>, any value that is set in the <code class="highlighter-rouge">$scope</code> object is visible in the GUI. Any changes in this variable will be reflected on the GUI expediently. Really, you do not have to update the GUI, it does it itself. The controller will therefore communicate with the back end to get the data and update the <code class="highlighter-rouge">$scope</code> object with that data.</li>
  <li>The <code class="highlighter-rouge">static/&lt;app name&gt;/main/htm/home.htm</code> and   <code class="highlighter-rouge">static/&lt;app name&gt;/main/htm/about.htm</code> contain the HTML for the Home and About page respectively. In these pages we can refer to the variables in the <code class="highlighter-rouge">$scope</code> using the <code class="highlighter-rouge">{{</code> and <code class="highlighter-rouge">}}</code> syntax.</li>
</ul>

<p>Schematically, the architecture from a 30.000 feet overview looks like:</p>

<p><img src="img/angular.png" alt="Angular extremely high level overview" /></p>

<p>For example, the code in the REST server can look like:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AtomicInteger</span> <span class="n">n</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">getFoo</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="s">"FOO "</span> <span class="o">+</span> <span class="n">n</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The code in the <code class="highlighter-rouge">web/main.js</code> would contain the controller. If the controller gets called then we fetch the data from the server. Since Javascript is single threaded, we use a <em>promise</em> to get the result in a callback. In this callback we then update the <code class="highlighter-rouge">$scope</code>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">MODULE</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'&lt;app name&gt;'</span><span class="p">,</span>
		<span class="p">[</span> <span class="s1">'ngRoute'</span><span class="p">]);</span>

<span class="nx">MODULE</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$routeProvider</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">$routeProvider</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span> 
		<span class="na">controller</span><span class="p">:</span>  <span class="nx">mainProvider</span><span class="p">,</span> 
		<span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'/&lt;app name&gt;/main/htm/home.htm'</span>
	<span class="p">});</span>
	<span class="nx">$routeProvider</span><span class="p">.</span><span class="nx">otherwise</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">mainProvider</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">$http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/rest/foo'</span><span class="p">);</span>
  <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
	<span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>All that is now left is to show the result in the HTML, e.g. <code class="highlighter-rouge">static/&lt;app name&gt;/main/htm/home.htm</code>.</p>

<p>The template is a bit more complicated to support calling the REST server with a parameter, but the idea is the same.</p>

<p>The hardest part of Angular is to learn to live with what feels like <em>a lack of control</em>. We’re very much used to ‘if this happens then do that’. In Angular, the basic idea is to always keep the <code class="highlighter-rouge">$scope</code> up to date and the GUI will take care of itself. In the GUI, you enable and disable <code class="highlighter-rouge">&lt;div&gt;</code> elements based on the state of the <code class="highlighter-rouge">$scope</code>, rarely on events. Buttons update data or initiate a HTTP request that gets set later, but you almost never update the GUI directly.</p>

<p>And one more thing. It does feel a bit like magic how the data updates are instantaneously reflected in the GUI.</p>

<h2 id="the-chat-application-java">The Chat Application (Java)</h2>

<p>Since we will use the Chat API in the application, we need to add the API project to our <code class="highlighter-rouge">-buildpath</code>.</p>

<p>The <code class="highlighter-rouge">ChatApplication</code> class is a REST server. We need the following URLs:</p>

<ul>
  <li><code class="highlighter-rouge">GET /rest/users</code> – Provide a list of users</li>
  <li><code class="highlighter-rouge">PUT /rest/message</code> – Send a message</li>
</ul>

<p>For these functions we need to maintain a map of Chat services indexed by name. Since this list can dynamically change, we need to be able to notify the browser when the list changes, we’ll achieve this with Event Admin service. The code for the <code class="highlighter-rouge">ChatApplication</code> class then looks like:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">osgi</span><span class="o">.</span><span class="na">enroute</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">chat</span><span class="o">.</span><span class="na">application</span><span class="o">;</span>
	
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.osgi.service.component.annotations.Activate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.component.annotations.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.component.annotations.Reference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.component.annotations.ReferenceCardinality</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.component.annotations.ReferencePolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.event.Event</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.event.EventAdmin</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">osgi.enroute.configurer.api.RequireConfigurerExtender</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.eventadminserversentevents.capabilities.RequireEventAdminServerSentEventsWebResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.examples.chat.api.Chat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.examples.chat.api.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.google.angular.capabilities.RequireAngularWebResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.rest.api.REST</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.twitter.bootstrap.capabilities.RequireBootstrapWebResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.webserver.capabilities.RequireWebServerExtender</span><span class="o">;</span>

<span class="nd">@RequireAngularWebResource</span><span class="o">(</span><span class="n">resource</span><span class="o">={</span><span class="s">"angular.js"</span><span class="o">,</span><span class="s">"angular-resource.js"</span><span class="o">,</span> <span class="s">"angular-route.js"</span><span class="o">},</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1000</span><span class="o">)</span>
<span class="nd">@RequireBootstrapWebResource</span><span class="o">(</span><span class="n">resource</span><span class="o">=</span><span class="s">"css/bootstrap.css"</span><span class="o">)</span>
<span class="nd">@RequireWebServerExtender</span>
<span class="nd">@RequireConfigurerExtender</span>
<span class="nd">@RequireEventAdminServerSentEventsWebResource</span>
<span class="nd">@Component</span><span class="o">(</span>
	<span class="c1">// CHANGE</span>
	<span class="n">name</span><span class="o">=</span><span class="s">"osgi.enroute.examples.chat.provider"</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatApplication</span> <span class="kd">implements</span> <span class="n">REST</span> <span class="o">{</span>
  
  <span class="c1">// CHANGE</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">MESSAGE_TOPIC</span> <span class="o">=</span> <span class="s">"osgi/enroute/examples/chat/message"</span><span class="o">;</span>
  <span class="c1">// CHANGE</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">USERS_TOPIC</span> <span class="o">=</span> <span class="s">"osgi/enroute/examples/chat/users"</span><span class="o">;</span>

  <span class="nd">@Reference</span>
  <span class="n">EventAdmin</span>  <span class="n">eventAdmin</span><span class="o">;</span>
  
  <span class="kd">private</span> <span class="n">String</span> <span class="n">localUser</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">usersChanged</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Event</span><span class="o">(</span><span class="n">USERS_TOPIC</span><span class="o">,</span> <span class="n">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="n">Chat</span><span class="o">.</span><span class="na">USER_NAME</span><span class="o">,</span> <span class="n">userName</span><span class="o">));</span>
	<span class="n">eventAdmin</span><span class="o">.</span><span class="na">postEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Chat</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
  
  <span class="nd">@Reference</span><span class="o">(</span><span class="n">cardinality</span> <span class="o">=</span> <span class="n">ReferenceCardinality</span><span class="o">.</span><span class="na">MULTIPLE</span><span class="o">,</span> <span class="n">policy</span> <span class="o">=</span> <span class="n">ReferencePolicy</span><span class="o">.</span><span class="na">DYNAMIC</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">addChat</span><span class="o">(</span><span class="n">Chat</span> <span class="n">chat</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Chat</span><span class="o">.</span><span class="na">USER_NAME</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">users</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">chat</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	  <span class="k">if</span> <span class="o">(</span> <span class="n">isLocal</span><span class="o">(</span><span class="n">map</span><span class="o">))</span>
		<span class="n">localUser</span> <span class="o">=</span> <span class="n">userName</span><span class="o">;</span>
	  <span class="n">usersChanged</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
	<span class="o">}</span>
  <span class="o">}</span>
  
  <span class="kt">void</span> <span class="nf">removeChat</span><span class="o">(</span><span class="n">Chat</span> <span class="n">chat</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Chat</span><span class="o">.</span><span class="na">USER_NAME</span><span class="o">);</span>
	<span class="n">Chat</span> <span class="n">remove</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">remove</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
	  <span class="n">usersChanged</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isLocal</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
	 <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"service.exported.interfaces"</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">users</span><span class="o">.</span><span class="na">keySet</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">putMessage</span><span class="o">(</span> <span class="n">Message</span> <span class="n">message</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="n">Chat</span> <span class="n">c</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">to</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span> <span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
	  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="n">message</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="n">localUser</span><span class="o">;</span>
	<span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Don’t forget to change the component name and the used topic to your own namespace.</p>

<p>Changing this class adds additional requirements. You have to Resolve the <code class="highlighter-rouge">debug.bndrun</code> file and <code class="highlighter-rouge">debug-alt.bndrun</code> file and save them. If you run into problems, then restart these bndrun files.</p>

<h2 id="using-event-admin-in-the-chat-implementation">Using Event Admin in the Chat Implementation</h2>

<p>Currently we’re just outputting the messages to the console. To make the GUI update automatically, we need to send out events via Event Admin. So chaneg the <code class="highlighter-rouge">ChatImpl</code> class in the <code class="highlighter-rouge">osgi.enroute.examples.chat.provider</code> project to:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">osgi</span><span class="o">.</span><span class="na">enroute</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">chat</span><span class="o">.</span><span class="na">adapter</span><span class="o">;</span>
	
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.osgi.service.component.annotations.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.component.annotations.Reference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.event.Event</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.event.EventAdmin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.metatype.annotations.Designate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.metatype.annotations.ObjectClassDefinition</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">osgi.enroute.dto.api.DTOs</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.examples.chat.api.Chat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">osgi.enroute.examples.chat.api.Message</span><span class="o">;</span>

<span class="nd">@Designate</span><span class="o">(</span><span class="n">ocd</span><span class="o">=</span><span class="n">Configuration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">factory</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
<span class="nd">@Component</span><span class="o">(</span>
	<span class="n">name</span> <span class="o">=</span> <span class="s">"osgi.enroute.examples.chat"</span><span class="o">,</span> 	<span class="c1">// CHANGE</span>
	<span class="n">property</span> <span class="o">=</span> <span class="o">{</span>
		<span class="s">"user.name=osgi"</span><span class="o">,</span> 
		<span class="s">"service.exported.interfaces=*"</span>
	<span class="o">}</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatImpl</span> <span class="kd">implements</span> <span class="n">Chat</span> <span class="o">{</span>
	
	<span class="nd">@Reference</span>
	<span class="n">EventAdmin</span> <span class="n">eventAdmin</span><span class="o">;</span>
	
	<span class="nd">@Reference</span>
	<span class="n">DTOs</span> <span class="n">dtos</span><span class="o">;</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">send</span><span class="o">(</span><span class="n">Message</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s: %s%n"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">from</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
		
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">dtos</span><span class="o">.</span><span class="na">asMap</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
		<span class="c1">// CHANGE</span>
		<span class="n">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Event</span><span class="o">(</span><span class="s">"osgi/enroute/examples/chat/message"</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
		<span class="n">eventAdmin</span><span class="o">.</span><span class="na">postEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Don’t forget to change the component name and the used topic to your own namespace.</p>

<h2 id="the-main-front-end-javascript">The Main Front End (Javascript)</h2>

<p>The <code class="highlighter-rouge">web/main.js</code> file is our ‘main’ Javascript file. It is loaded automatically in our <code class="highlighter-rouge">index.html</code> file. It contains an Angular module that is configured and initialized. We configure a routing table to the ‘home’ page and define a <em>controller</em>. The home page’s html is defined in <code class="highlighter-rouge">static/osgi.enroute.examples.chat/main/htm/home.htm</code>.</p>

<p>The controller initializes a <code class="highlighter-rouge">chat</code> object with a <code class="highlighter-rouge">users</code> list, a selected <code class="highlighter-rouge">user</code>, and a <code class="highlighter-rouge">history</code>. It then fetches the list of users every time an event is received signalling the list has changed. We also provide a <code class="highlighter-rouge">send(string)</code> function to send a message to the host via the <code class="highlighter-rouge">PUT /rest/message</code> URI.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'use strict'</span><span class="p">;</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">MODULE</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span>
	<span class="s1">'osgi.enroute.examples.chat'</span><span class="p">,</span>   <span class="c1">// CHANGE</span>
	 <span class="p">[</span> <span class="s1">'ngRoute'</span><span class="p">,</span> <span class="s1">'enEasse'</span> <span class="p">]);</span>
	  
  <span class="nx">MODULE</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$routeProvider</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">$routeProvider</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span> 
	  <span class="na">controller</span><span class="p">:</span> <span class="nx">mainProvider</span><span class="p">,</span> 
	  <span class="c1">// CHANGE</span>
	  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'/osgi.enroute.examples.chat/main/htm/home.htm'</span><span class="p">}</span>
	<span class="p">);</span>
	<span class="nx">$routeProvider</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/about'</span><span class="p">,</span> <span class="p">{</span> 
	  <span class="c1">// CHANGE</span>
	  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'/osgi.enroute.examples.chat/main/htm/about.htm'</span><span class="p">}</span>
	<span class="p">);</span>
	<span class="nx">$routeProvider</span><span class="p">.</span><span class="nx">otherwise</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">alerts</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">chat</span> <span class="o">=</span> <span class="p">{</span> 
	<span class="na">users</span><span class="p">:</span> <span class="p">[],</span> 
	<span class="na">history</span><span class="p">:</span> <span class="p">[],</span> 
	<span class="na">user</span><span class="p">:</span> <span class="kc">undefined</span> 
  <span class="p">};</span>
	
  <span class="kd">function</span> <span class="nx">error</span><span class="p">(</span> <span class="nx">msg</span> <span class="p">)</span> <span class="p">{</span>
	<span class="nx">alerts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'danger'</span><span class="p">,</span> <span class="na">msg</span><span class="p">:</span> <span class="nx">msg</span> <span class="p">});</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">webError</span><span class="p">(</span> <span class="nx">d</span> <span class="p">)</span> <span class="p">{</span>
	<span class="nx">error</span><span class="p">(</span> <span class="nx">d</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">MODULE</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">$rootScope</span><span class="p">.</span><span class="nx">alerts</span> <span class="o">=</span> <span class="nx">alerts</span><span class="p">;</span>
	<span class="nx">$rootScope</span><span class="p">.</span><span class="nx">closeAlert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
	  <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="nx">$rootScope</span><span class="p">.</span><span class="nx">page</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	  <span class="k">return</span> <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">();</span>
	<span class="p">}</span>
  <span class="p">});</span>
  
  <span class="kd">var</span> <span class="nx">mainProvider</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$http</span><span class="p">,</span> <span class="nx">en$easse</span><span class="p">)</span> <span class="p">{</span>
  
	<span class="nx">$scope</span><span class="p">.</span><span class="nx">chat</span> <span class="o">=</span> <span class="nx">chat</span><span class="p">;</span>
	
	<span class="kd">function</span> <span class="nx">refreshUsers</span><span class="p">()</span> <span class="p">{</span>
	  <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">$http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/rest/users'</span><span class="p">);</span>
	  <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> 
		<span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> 
		  <span class="nx">angular</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">users</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="nx">webError</span>
	  <span class="p">);</span>  
	<span class="p">}</span>
	
	<span class="nx">refreshUsers</span><span class="p">();</span>
	
	<span class="kd">var</span> <span class="nx">close</span> <span class="o">=</span> <span class="nx">en$easse</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="s2">"osgi/enroute/examples/chat/*"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
	  <span class="nx">$scope</span><span class="p">.</span><span class="nx">$applyAsync</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">[</span><span class="s1">'event.topics'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'osgi/enroute/examples/chat/message'</span><span class="p">)</span> 
		  <span class="nx">chat</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">from</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="k">from</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">text</span> <span class="p">});</span>
		<span class="k">else</span>
		  <span class="nx">refreshUsers</span><span class="p">();</span>
	  <span class="p">});</span>
	<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> <span class="p">);</span>
	
	<span class="nx">$scope</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="s1">'$destroy'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">close</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> <span class="p">})</span>

	<span class="nx">$scope</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
	  <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">'/rest/message'</span><span class="p">,</span> <span class="p">{</span> <span class="na">to</span><span class="p">:</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="nx">text</span><span class="p">});</span>
	  <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> 
		<span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">chat</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">from</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="nx">text</span> <span class="p">})</span>
		  <span class="nx">$scope</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
		<span class="p">},</span> 
		<span class="nx">webError</span>
	  <span class="p">);</span>  
	<span class="p">}</span>
  <span class="p">}</span>
<span class="p">})();</span>
</code></pre></div></div>

<p>Don’t forget to change the names to your own namespace. Important!</p>

<h2 id="the-display-html">The Display (HTML)</h2>

<p>We’re almost there. We now must replace the <code class="highlighter-rouge">static/osgi.enroute.examples.chat/main/htm/home.htm</code> file with the HTML definition of our user interface:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;section</span> <span class="na">ng-cloak</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-4 chat-user"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;p</span> 
	  <span class="na">ng-repeat  =</span><span class="s">"u in chat.users"</span>
	  <span class="na">ng-click  =</span><span class="s">chat.user=u</span>
	  <span class="na">class    =</span><span class="s">entry</span>
	  <span class="na">ng-class  =</span><span class="s">"{selected: u==chat.user}"</span>
	<span class="nt">&gt;</span>
	  
	<span class="nt">&lt;/p&gt;</span>        
  <span class="nt">&lt;/div&gt;</span>
  
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">col-md-8</span><span class="nt">&gt;</span>
	<span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form-inline"</span><span class="nt">&gt;</span>
	
	  <span class="nt">&lt;div</span> 
		<span class="na">class=</span><span class="s">chat-history</span><span class="nt">&gt;</span>
		<span class="nt">&lt;div</span> 
		  <span class="na">ng-repeat  =</span><span class="s">"m in chat.history"</span>
		  <span class="na">class=</span><span class="s">"message"</span>
		  <span class="na">ng-class  =</span><span class="s">"{'ours': !m.from}"</span><span class="nt">&gt;</span>
		  <span class="nt">&lt;b</span> 
			<span class="na">ng-show  =</span><span class="s">m.from</span><span class="nt">&gt;</span>
			 :
		  <span class="nt">&lt;/b&gt;</span>
		  
		<span class="nt">&lt;/div&gt;</span> 
	  <span class="nt">&lt;/div&gt;</span>
	  
	  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group chat-input"</span><span class="nt">&gt;</span>
		 <span class="nt">&lt;button</span>
		   <span class="na">class    =</span><span class="s">"btn btn-primary"</span>
		   <span class="na">ng-click  =</span><span class="s">send(text)</span>
		   <span class="na">ng-disabled  =</span><span class="s">!chat.user</span><span class="nt">&gt;</span>
			Send
		 <span class="nt">&lt;/button&gt;</span>
		 <span class="nt">&lt;input</span> 
		   <span class="na">type    =</span><span class="s">"text"</span> 
		   <span class="na">class    =</span><span class="s">"form-control"</span> 
		   <span class="na">placeholder  =</span><span class="s">"..."</span>
		   <span class="na">ng-model  =</span><span class="s">text</span><span class="nt">&gt;</span>
		<span class="nt">&lt;/div&gt;</span>
	  <span class="nt">&lt;/form&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/section&gt;</span>
</code></pre></div></div>

<h2 id="the-styling-css">The Styling (CSS)</h2>

<p>Though Bootstrap makes it hard, we tried to keep the HTML free from low level formatting decisions. However, to make the UI look not too unfriendly, we need to provide some CSS. This CSS is <code class="highlighter-rouge">web/style.css</code>. This file already contains styling for the <code class="highlighter-rouge">index.html</code> page, so you should add the following text at the start or end:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.chat-user</span> <span class="nc">.entry</span> <span class="p">{</span>             <span class="nl">padding</span><span class="p">:</span>                   <span class="m">5px</span><span class="p">;</span>
								<span class="nl">border-radius</span><span class="p">:</span>             <span class="m">5px</span><span class="p">;</span>
								<span class="nl">background-color</span><span class="p">:</span>       <span class="m">#d9edf7</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.chat-user</span> <span class="nc">.entry.selected</span> <span class="p">{</span>    <span class="nl">background-color</span><span class="p">:</span>       <span class="m">#337ab7</span><span class="p">;</span>
								<span class="nl">color</span><span class="p">:</span>                    <span class="no">white</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.chat-history</span> <span class="p">{</span>                 <span class="nl">min-height</span><span class="p">:</span>               <span class="m">400px</span><span class="p">;</span>
								<span class="nl">border-radius</span><span class="p">:</span>              <span class="m">5px</span><span class="p">;</span>
								<span class="nl">border</span><span class="p">:</span>     <span class="m">1px</span> <span class="nb">solid</span> <span class="no">lightgrey</span><span class="p">;</span>
								<span class="nl">margin-bottom</span><span class="p">:</span>             <span class="m">10px</span><span class="p">;</span>
								<span class="nl">padding</span><span class="p">:</span>                    <span class="m">5px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.chat-input</span> <span class="p">{</span>                   <span class="nl">width</span><span class="p">:</span>                     <span class="m">100%</span><span class="p">;</span>
								<span class="nl">margin-bottom</span><span class="p">:</span>             <span class="m">10px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.chat-input</span> <span class="nt">button</span> <span class="p">{</span>            <span class="nl">width</span><span class="p">:</span>                      <span class="m">25%</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.chat-input</span> <span class="nt">input</span> <span class="p">{</span>             <span class="nl">min-width</span><span class="p">:</span>                  <span class="m">72%</span><span class="p">;</span> 
								<span class="nl">float</span><span class="p">:</span>                    <span class="nb">right</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.chat-history</span> <span class="nc">.message</span> <span class="p">{</span>        <span class="nl">background-color</span><span class="p">:</span>       <span class="m">#F4F4F4</span><span class="p">;</span>
								<span class="nl">color</span><span class="p">:</span>                    <span class="no">black</span><span class="p">;</span>
								<span class="nl">border-radius</span><span class="p">:</span>              <span class="m">5px</span><span class="p">;</span>
								<span class="nl">text-align</span><span class="p">:</span>                <span class="nb">left</span><span class="p">;</span>	
								<span class="nl">margin-left</span><span class="p">:</span>                <span class="m">0px</span><span class="p">;</span> 
								<span class="nl">margin-right</span><span class="p">:</span>              <span class="m">50px</span><span class="p">;</span> 
								<span class="nl">margin-bottom</span><span class="p">:</span>             <span class="m">10px</span><span class="p">;</span>
								<span class="nl">padding</span><span class="p">:</span>                   <span class="m">10px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.chat-history</span> <span class="nc">.message.ours</span> <span class="p">{</span>   <span class="nl">color</span><span class="p">:</span>                    <span class="no">white</span><span class="p">;</span> 
								<span class="nl">background-color</span><span class="p">:</span>       <span class="m">#2BAD2B</span><span class="p">;</span>
								<span class="nl">text-align</span><span class="p">:</span>               <span class="nb">right</span><span class="p">;</span>	
								<span class="nl">margin-left</span><span class="p">:</span>               <span class="m">50px</span><span class="p">;</span> 
								<span class="nl">margin-right</span><span class="p">:</span>               <span class="m">0px</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">section</span> <span class="p">{</span>                       <span class="nl">margin-bottom</span><span class="p">:</span>             <span class="m">10px</span><span class="p">;</span> <span class="p">}</span>

</code></pre></div></div>

<h2 id="running">Running</h2>

<p>Before your run verify closely that you have replaced all the strings that start with <code class="highlighter-rouge">org.osgi.examples.chat</code>. If you have replaced them inconsistently then you’re in for a nice debugging session.</p>

<p>In principle, you should still be running your cluster (Zookeeper, your client, alternative clients). If you’re not sure about the state, then terminate all running frameworks and Zookeeper. The look at the <a href="240-distributing.html#cluster">Cluster setup</a> how to run the cluster.</p>

<p>After you made these changes you can then goto <a href="http://localhost:8080">http://localhost:8080</a>. This home page contains a link to your application.</p>

<p>If it all works, you should get a window like this:</p>

<p><img src="img/chatwindow-1.png" alt="Chat Window" /></p>


		    </div>
			<div class="col hide-on-med-and-down l2">
				<div id="toc-wrapper" class="toc-wrapper pin-top">
				  <ul id="toc" class="section table-of-contents">
					
				  </ul>
				</div>
			</div>
			
			
				
				<div class="col s6 left-align hide-on-large-only show-on-med-and-down"><a href="distributing.html"><i class="large material-icons">keyboard_arrow_left</i></a></div>
			
			
				<div class="col s6  right-align hide-on-large-only show-on-med-and-down"><a href="start.html"><i class="large material-icons">keyboard_arrow_right</i></a></div>
			
			
			
				<div class="prev-nav hide-on-med-and-down"><a href="distributing.html"><i class="small material-icons">keyboard_arrow_left</i></a></div>
			
			
				<div class="next-nav hide-on-med-and-down"><a href="start.html"><i class="small material-icons">keyboard_arrow_right</i></a></div>
			
		
			
    </div> 
	
  </div>
  </main>
	<footer class="page-footer">
    <!--<div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5>Lorem Ipsum</h5>
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        </div>
      </div>
    </div>-->
    <div class="footer-copyright">
        <div class="container">
            <div>
				<span style="text-align: left; float: left; width: 30%;">
				Made with <a target="_blank" href="http://materializecss.com">Materialize</a>
				</span>
				<span style="text-align: center; float: left; width: 40%;">
				Copyright © 2018 <a href="https://twitter.com/SanfteSchorle">Thomas Driessen</a>
				</span>
                <span style="text-align: right; float: left; width: 30%;">
				Powered by <a target="_blank" href="http://jekyllrb.com/">Jekyll</a>
                </span>
            </div>
        </div>
    </div>
</footer>      
	<!--  Scripts-->  

<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/materialize.min.js"></script>
<script src="/assets/js/init.js"></script>	
	<script src="/assets/js/content.js"></script>	
  </body>

</html>